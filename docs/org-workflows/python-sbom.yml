# ============================================================================
# Reusable Python SBOM & Security Scan Workflow
# ============================================================================
# This workflow should be placed in your organization's .github repository at:
#   .github/workflows/python-sbom.yml
#
# Projects call this workflow using:
#   uses: ORG/.github/.github/workflows/python-sbom.yml@main
#
# Features:
#   - CycloneDX SBOM generation
#   - Trivy vulnerability scanning
#   - License compliance checking
#   - SARIF upload to GitHub Security tab
# ============================================================================

name: Reusable Python SBOM

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      fail-on-vulnerabilities:
        description: 'Fail workflow on CRITICAL/HIGH vulnerabilities'
        required: false
        type: boolean
        default: true
      severity-threshold:
        description: 'Severity threshold (CRITICAL, HIGH, MEDIUM, LOW)'
        required: false
        type: string
        default: 'CRITICAL,HIGH'
      artifact-retention-days:
        description: 'Days to retain SBOM artifacts'
        required: false
        type: number
        default: 90
      forbidden-licenses:
        description: 'JSON array of forbidden SPDX license IDs'
        required: false
        type: string
        default: '["GPL-2.0-only", "GPL-2.0-or-later", "GPL-3.0-only", "GPL-3.0-or-later", "AGPL-3.0-only", "AGPL-3.0-or-later"]'
      fail-on-forbidden-licenses:
        description: 'Fail workflow on forbidden licenses'
        required: false
        type: boolean
        default: false

permissions: read-all

jobs:
  # ============================================================================
  # Job 1: Generate SBOMs
  # ============================================================================
  generate-sbom:
    name: Generate SBOMs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install cyclonedx-bom
        run: pip install cyclonedx-bom==4.6.1

      - name: Install dependencies
        run: uv sync --frozen

      - name: Generate runtime SBOM (production dependencies)
        run: |
          cyclonedx-py environment \
            --of json \
            -o sbom-runtime.json \
            .venv

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: sboms
          path: sbom-*.json
          retention-days: ${{ inputs.artifact-retention-days }}

  # ============================================================================
  # Job 2: Scan Runtime Dependencies
  # ============================================================================
  scan-runtime:
    name: Scan Runtime Dependencies
    needs: generate-sbom
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    steps:
      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Trivy SBOM scan (runtime)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-runtime.json
          format: table
          severity: ${{ inputs.severity-threshold }}
          exit-code: ${{ inputs.fail-on-vulnerabilities && '1' || '0' }}

      - name: Trivy SBOM scan (runtime - detailed report)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-runtime.json
          format: sarif
          output: trivy-runtime-results.sarif

      - name: Upload Trivy results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.27.5
        with:
          sarif_file: trivy-runtime-results.sarif
          category: trivy-runtime-deps

  # ============================================================================
  # Job 3: License Compliance Check
  # ============================================================================
  license-compliance:
    name: License Compliance Check
    needs: generate-sbom
    runs-on: ubuntu-latest
    steps:
      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Check licenses in runtime SBOM
        env:
          FORBIDDEN_LICENSES: ${{ inputs.forbidden-licenses }}
          FAIL_ON_FORBIDDEN: ${{ inputs.fail-on-forbidden-licenses }}
        run: |
          echo "Checking runtime dependency licenses..."
          python -c "
          import json
          import os
          import sys

          with open('sbom-runtime.json') as f:
              sbom = json.load(f)

          # Parse forbidden licenses from input
          forbidden_licenses = json.loads(os.environ.get('FORBIDDEN_LICENSES', '[]'))
          fail_on_forbidden = os.environ.get('FAIL_ON_FORBIDDEN', 'false').lower() == 'true'
          issues = []

          for component in sbom.get('components', []):
              licenses = component.get('licenses', [])
              for lic in licenses:
                  lic_id = lic.get('license', {}).get('id', '')
                  if lic_id in forbidden_licenses:
                      issues.append(f\"{component['name']}: {lic_id}\")

          if issues:
              print('WARNING: Found potentially incompatible licenses:')
              for issue in issues:
                  print(f'  - {issue}')
              if fail_on_forbidden:
                  sys.exit(1)
          else:
              print('All licenses compatible')
          "
