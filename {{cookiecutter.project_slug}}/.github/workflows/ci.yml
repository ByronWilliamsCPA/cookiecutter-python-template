# CI/CD Pipeline - Calls Org-Level Reusable Workflow
# This is a lightweight caller workflow that invokes the organization's
# shared Python CI workflow with LLM governance integration.
#
# Features:
#   - Standard quality checks (tests, linting, type checking)
#   - LLM governance and assumption tag verification
#   - Optional SonarCloud integration
#   - Optional Codecov integration
#   - Security scanning (Bandit, Safety)
{% if cookiecutter.include_github_actions == "yes" -%}
name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]
  workflow_dispatch:

# Cancel in-progress runs for same PR/branch
concurrency:
  group: {% raw %}${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}{% endraw %}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  ci:
    name: CI Pipeline
    uses: {{ cookiecutter.github_org_or_user }}/.github/.github/workflows/python-ci.yml@main
    with:
      python-version: '{{ cookiecutter.python_version }}'
      coverage-threshold: {{ cookiecutter.code_coverage_target }}
      source-directory: 'src'
      test-directory: 'tests'
      {%- if cookiecutter.include_sonarcloud == "yes" %}
      enable-sonarcloud: true
      sonarcloud-organization: '{{ cookiecutter.github_org_or_user }}'
      sonarcloud-project-key: '{{ cookiecutter.github_org_or_user }}_{{ cookiecutter.project_slug }}'
      {%- else %}
      enable-sonarcloud: false
      {%- endif %}
      {%- if cookiecutter.include_codecov == "yes" %}
      enable-codecov: true
      {%- else %}
      enable-codecov: false
      {%- endif %}
      run-integration-tests: true
      run-security-tests: true
      fail-on-llm-tags: false
    secrets:
      {%- if cookiecutter.include_sonarcloud == "yes" %}
      SONAR_TOKEN: {% raw %}${{ secrets.SONAR_TOKEN }}{% endraw %}
      {%- endif %}
      {%- if cookiecutter.include_codecov == "yes" %}
      CODECOV_TOKEN: {% raw %}${{ secrets.CODECOV_TOKEN }}{% endraw %}
      {%- endif %}
{% endif -%}
